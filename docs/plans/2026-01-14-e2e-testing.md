# CarpTrack E2E Testing Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Implement comprehensive end-to-end tests covering all critical user flows in CarpTrack using Playwright.

**Architecture:** Playwright Test framework with Page Object Model (POM) pattern for maintainability. Tests will use Convex test utilities for database seeding/cleanup. Auth state will be persisted via storageState to speed up test runs.

**Tech Stack:** Playwright, TypeScript, Convex (for seeding), @playwright/test assertions

---

## Prerequisites

Before starting, ensure:
- Convex dev server is running (`npx convex dev`)
- Next.js dev server is running (`npm run dev`)
- Both servers use the same Convex deployment

---

## Task 1: Install Playwright and Configure

**Files:**
- Modify: `package.json`
- Create: `playwright.config.ts`
- Create: `e2e/.gitkeep`

**Step 1: Install Playwright**

Run:
```bash
npm install -D @playwright/test
npx playwright install chromium
```

Expected: Playwright packages added to devDependencies, Chromium browser installed

**Step 2: Create Playwright configuration**

Create `playwright.config.ts`:

```typescript
import { defineConfig, devices } from '@playwright/test';

export default defineConfig({
  testDir: './e2e',
  fullyParallel: false, // Run sequentially for data consistency
  forbidOnly: !!process.env.CI,
  retries: process.env.CI ? 2 : 0,
  workers: 1,
  reporter: [['html', { open: 'never' }], ['list']],

  use: {
    baseURL: 'http://localhost:3000',
    trace: 'on-first-retry',
    screenshot: 'only-on-failure',
    video: 'retain-on-failure',
  },

  projects: [
    {
      name: 'chromium',
      use: { ...devices['Desktop Chrome'] },
    },
  ],

  webServer: {
    command: 'npm run dev',
    url: 'http://localhost:3000',
    reuseExistingServer: !process.env.CI,
    timeout: 120000,
  },
});
```

**Step 3: Add test scripts to package.json**

Add to `scripts` in `package.json`:

```json
{
  "scripts": {
    "test:e2e": "playwright test",
    "test:e2e:ui": "playwright test --ui",
    "test:e2e:debug": "playwright test --debug"
  }
}
```

**Step 4: Create e2e directory**

Run:
```bash
mkdir -p e2e
```

**Step 5: Commit**

```bash
git add package.json package-lock.json playwright.config.ts e2e/
git commit -m "chore: add Playwright E2E testing setup"
```

---

## Task 2: Create Test Utilities and Seed Data Helpers

**Files:**
- Create: `e2e/utils/test-data.ts`
- Create: `e2e/utils/auth-helpers.ts`
- Create: `convex/testing.ts`

**Step 1: Create Convex testing functions**

Create `convex/testing.ts`:

```typescript
import { mutation, query } from "./_generated/server";
import { v } from "convex/values";

// WARNING: These functions are for testing only. Do not use in production.
// They bypass normal auth checks.

export const seedTestOrganization = mutation({
  args: {
    orgName: v.string(),
    ownerEmail: v.string(),
    ownerName: v.string(),
    ownerPassword: v.string(),
  },
  handler: async (ctx, args) => {
    // Check if org already exists
    const existingOrg = await ctx.db
      .query("organizations")
      .filter((q) => q.eq(q.field("name"), args.orgName))
      .first();

    if (existingOrg) {
      // Return existing data
      const existingUser = await ctx.db
        .query("users")
        .withIndex("by_organization", (q) => q.eq("organizationId", existingOrg._id))
        .filter((q) => q.eq(q.field("email"), args.ownerEmail))
        .first();
      return {
        organizationId: existingOrg._id,
        userId: existingUser?._id,
      };
    }

    // Create organization
    const organizationId = await ctx.db.insert("organizations", {
      name: args.orgName,
      abn: "12345678901",
      createdAt: Date.now(),
    });

    // Hash password (same as auth.ts)
    const encoder = new TextEncoder();
    const data = encoder.encode(args.ownerPassword);
    const hashBuffer = await crypto.subtle.digest("SHA-256", data);
    const hashArray = Array.from(new Uint8Array(hashBuffer));
    const passwordHash = hashArray.map((b) => b.toString(16).padStart(2, "0")).join("");

    // Create owner user
    const userId = await ctx.db.insert("users", {
      email: args.ownerEmail,
      name: args.ownerName,
      role: "owner",
      organizationId,
      passwordHash,
      createdAt: Date.now(),
    });

    // Create company chat channel
    await ctx.db.insert("chatChannels", {
      organizationId,
      type: "company",
      participants: [userId],
      createdAt: Date.now(),
    });

    return { organizationId, userId };
  },
});

export const seedTestBuilder = mutation({
  args: {
    organizationId: v.id("organizations"),
    companyName: v.string(),
    contactName: v.string(),
    contactEmail: v.string(),
    contactPhone: v.string(),
  },
  handler: async (ctx, args) => {
    // Check if builder exists
    const existingBuilder = await ctx.db
      .query("builders")
      .withIndex("by_organization", (q) => q.eq("organizationId", args.organizationId))
      .filter((q) => q.eq(q.field("companyName"), args.companyName))
      .first();

    if (existingBuilder) {
      return { builderId: existingBuilder._id };
    }

    const builderId = await ctx.db.insert("builders", {
      organizationId: args.organizationId,
      companyName: args.companyName,
      abn: "98765432109",
      paymentTerms: 30,
      status: "active",
      createdAt: Date.now(),
    });

    await ctx.db.insert("builderContacts", {
      builderId,
      name: args.contactName,
      email: args.contactEmail,
      phone: args.contactPhone,
      role: "Project Manager",
      isPrimary: true,
    });

    return { builderId };
  },
});

export const seedTestWorker = mutation({
  args: {
    organizationId: v.id("organizations"),
    name: v.string(),
    email: v.string(),
    phone: v.string(),
    password: v.string(),
    payRate: v.number(),
    chargeOutRate: v.number(),
  },
  handler: async (ctx, args) => {
    // Check if worker exists
    const existingWorker = await ctx.db
      .query("workers")
      .withIndex("by_organization", (q) => q.eq("organizationId", args.organizationId))
      .filter((q) => q.eq(q.field("email"), args.email))
      .first();

    if (existingWorker) {
      const existingUser = await ctx.db
        .query("users")
        .filter((q) => q.eq(q.field("workerId"), existingWorker._id))
        .first();
      return { workerId: existingWorker._id, userId: existingUser?._id };
    }

    // Create worker profile
    const workerId = await ctx.db.insert("workers", {
      organizationId: args.organizationId,
      name: args.name,
      phone: args.phone,
      email: args.email,
      emergencyContact: {
        name: "Emergency Contact",
        phone: "0400000000",
        relationship: "Spouse",
      },
      employmentType: "employee",
      tradeClassification: "qualified",
      payRate: args.payRate,
      chargeOutRate: args.chargeOutRate,
      startDate: Date.now(),
      status: "active",
    });

    // Hash password
    const encoder = new TextEncoder();
    const data = encoder.encode(args.password);
    const hashBuffer = await crypto.subtle.digest("SHA-256", data);
    const hashArray = Array.from(new Uint8Array(hashBuffer));
    const passwordHash = hashArray.map((b) => b.toString(16).padStart(2, "0")).join("");

    // Create user account
    const userId = await ctx.db.insert("users", {
      email: args.email,
      name: args.name,
      role: "worker",
      organizationId: args.organizationId,
      workerId,
      passwordHash,
      createdAt: Date.now(),
    });

    // Add to company chat
    const companyChannel = await ctx.db
      .query("chatChannels")
      .withIndex("by_organization", (q) => q.eq("organizationId", args.organizationId))
      .filter((q) => q.eq(q.field("type"), "company"))
      .first();

    if (companyChannel) {
      await ctx.db.patch(companyChannel._id, {
        participants: [...companyChannel.participants, userId],
      });
    }

    return { workerId, userId };
  },
});

export const seedTestJob = mutation({
  args: {
    organizationId: v.id("organizations"),
    builderId: v.id("builders"),
    name: v.string(),
    siteAddress: v.string(),
    jobType: v.union(v.literal("contract"), v.literal("labourHire")),
    quotedPrice: v.optional(v.number()),
    status: v.optional(v.union(
      v.literal("pending"),
      v.literal("active"),
      v.literal("onHold"),
      v.literal("completed"),
      v.literal("invoiced")
    )),
  },
  handler: async (ctx, args) => {
    // Check if job exists
    const existingJob = await ctx.db
      .query("jobs")
      .withIndex("by_organization", (q) => q.eq("organizationId", args.organizationId))
      .filter((q) => q.eq(q.field("name"), args.name))
      .first();

    if (existingJob) {
      return { jobId: existingJob._id };
    }

    const jobId = await ctx.db.insert("jobs", {
      organizationId: args.organizationId,
      builderId: args.builderId,
      name: args.name,
      siteAddress: args.siteAddress,
      jobType: args.jobType,
      quotedPrice: args.quotedPrice,
      status: args.status ?? "active",
      startDate: Date.now(),
      createdAt: Date.now(),
    });

    // Create job chat channel
    await ctx.db.insert("chatChannels", {
      organizationId: args.organizationId,
      type: "job",
      jobId,
      participants: [],
      createdAt: Date.now(),
    });

    return { jobId };
  },
});

export const cleanupTestData = mutation({
  args: {
    orgName: v.string(),
  },
  handler: async (ctx, args) => {
    const org = await ctx.db
      .query("organizations")
      .filter((q) => q.eq(q.field("name"), args.orgName))
      .first();

    if (!org) return { deleted: false };

    // Delete all related data in order (respecting foreign keys)
    const users = await ctx.db
      .query("users")
      .withIndex("by_organization", (q) => q.eq("organizationId", org._id))
      .collect();

    const workers = await ctx.db
      .query("workers")
      .withIndex("by_organization", (q) => q.eq("organizationId", org._id))
      .collect();

    const builders = await ctx.db
      .query("builders")
      .withIndex("by_organization", (q) => q.eq("organizationId", org._id))
      .collect();

    const jobs = await ctx.db
      .query("jobs")
      .withIndex("by_organization", (q) => q.eq("organizationId", org._id))
      .collect();

    const channels = await ctx.db
      .query("chatChannels")
      .withIndex("by_organization", (q) => q.eq("organizationId", org._id))
      .collect();

    const invites = await ctx.db
      .query("workerInvites")
      .withIndex("by_organization", (q) => q.eq("organizationId", org._id))
      .collect();

    // Delete messages in channels
    for (const channel of channels) {
      const messages = await ctx.db
        .query("chatMessages")
        .withIndex("by_channel", (q) => q.eq("channelId", channel._id))
        .collect();
      for (const msg of messages) {
        await ctx.db.delete(msg._id);
      }
      await ctx.db.delete(channel._id);
    }

    // Delete certifications
    for (const worker of workers) {
      const certs = await ctx.db
        .query("certifications")
        .withIndex("by_worker", (q) => q.eq("workerId", worker._id))
        .collect();
      for (const cert of certs) {
        await ctx.db.delete(cert._id);
      }
    }

    // Delete builder contacts
    for (const builder of builders) {
      const contacts = await ctx.db
        .query("builderContacts")
        .withIndex("by_builder", (q) => q.eq("builderId", builder._id))
        .collect();
      for (const contact of contacts) {
        await ctx.db.delete(contact._id);
      }
    }

    // Delete allocations and timesheets for jobs
    for (const job of jobs) {
      const allocations = await ctx.db
        .query("allocations")
        .withIndex("by_job", (q) => q.eq("jobId", job._id))
        .collect();
      for (const alloc of allocations) {
        await ctx.db.delete(alloc._id);
      }

      const timesheets = await ctx.db
        .query("timesheets")
        .withIndex("by_job", (q) => q.eq("jobId", job._id))
        .collect();
      for (const ts of timesheets) {
        await ctx.db.delete(ts._id);
      }

      const expenses = await ctx.db
        .query("expenses")
        .withIndex("by_job", (q) => q.eq("jobId", job._id))
        .collect();
      for (const exp of expenses) {
        await ctx.db.delete(exp._id);
      }

      await ctx.db.delete(job._id);
    }

    // Delete invites
    for (const invite of invites) {
      await ctx.db.delete(invite._id);
    }

    // Delete workers, builders, users
    for (const worker of workers) {
      await ctx.db.delete(worker._id);
    }
    for (const builder of builders) {
      await ctx.db.delete(builder._id);
    }
    for (const user of users) {
      await ctx.db.delete(user._id);
    }

    // Delete organization
    await ctx.db.delete(org._id);

    return { deleted: true };
  },
});
```

**Step 2: Create auth helpers**

Create `e2e/utils/auth-helpers.ts`:

```typescript
import { Page } from '@playwright/test';

export const TEST_OWNER = {
  email: 'e2e-owner@test.carptrack.com',
  password: 'TestPassword123!',
  name: 'E2E Test Owner',
  orgName: 'E2E Test Organization',
};

export const TEST_WORKER = {
  email: 'e2e-worker@test.carptrack.com',
  password: 'TestPassword456!',
  name: 'E2E Test Worker',
  phone: '0412345678',
  payRate: 55,
  chargeOutRate: 85,
};

export const TEST_BUILDER = {
  companyName: 'E2E Test Builder Pty Ltd',
  contactName: 'John Builder',
  contactEmail: 'john@testbuilder.com',
  contactPhone: '0498765432',
};

export const TEST_JOB = {
  name: 'E2E Test Kitchen Renovation',
  siteAddress: '123 Test Street, Sydney NSW 2000',
  jobType: 'contract' as const,
  quotedPrice: 25000,
};

export async function loginAsOwner(page: Page): Promise<void> {
  await page.goto('/sign-in');
  await page.getByPlaceholder('you@company.com').fill(TEST_OWNER.email);
  await page.getByPlaceholder('Enter your password').fill(TEST_OWNER.password);
  await page.getByRole('button', { name: 'Sign In' }).click();
  await page.waitForURL('/dashboard');
}

export async function loginAsWorker(page: Page): Promise<void> {
  await page.goto('/sign-in');
  await page.getByPlaceholder('you@company.com').fill(TEST_WORKER.email);
  await page.getByPlaceholder('Enter your password').fill(TEST_WORKER.password);
  await page.getByRole('button', { name: 'Sign In' }).click();
  await page.waitForURL('/dashboard');
}

export async function logout(page: Page): Promise<void> {
  // Clear localStorage to log out
  await page.evaluate(() => {
    localStorage.removeItem('carptrack_user_id');
  });
  await page.goto('/');
}
```

**Step 3: Create test data utilities**

Create `e2e/utils/test-data.ts`:

```typescript
import { ConvexHttpClient } from 'convex/browser';
import { api } from '../../convex/_generated/api';
import { TEST_OWNER, TEST_WORKER, TEST_BUILDER, TEST_JOB } from './auth-helpers';

const convex = new ConvexHttpClient(process.env.NEXT_PUBLIC_CONVEX_URL!);

export interface TestDataIds {
  organizationId: string;
  ownerId: string;
  workerId?: string;
  workerUserId?: string;
  builderId?: string;
  jobId?: string;
}

export async function seedAllTestData(): Promise<TestDataIds> {
  // Seed organization and owner
  const orgResult = await convex.mutation(api.testing.seedTestOrganization, {
    orgName: TEST_OWNER.orgName,
    ownerEmail: TEST_OWNER.email,
    ownerName: TEST_OWNER.name,
    ownerPassword: TEST_OWNER.password,
  });

  const ids: TestDataIds = {
    organizationId: orgResult.organizationId,
    ownerId: orgResult.userId!,
  };

  // Seed worker
  const workerResult = await convex.mutation(api.testing.seedTestWorker, {
    organizationId: orgResult.organizationId,
    name: TEST_WORKER.name,
    email: TEST_WORKER.email,
    phone: TEST_WORKER.phone,
    password: TEST_WORKER.password,
    payRate: TEST_WORKER.payRate,
    chargeOutRate: TEST_WORKER.chargeOutRate,
  });
  ids.workerId = workerResult.workerId;
  ids.workerUserId = workerResult.userId;

  // Seed builder
  const builderResult = await convex.mutation(api.testing.seedTestBuilder, {
    organizationId: orgResult.organizationId,
    companyName: TEST_BUILDER.companyName,
    contactName: TEST_BUILDER.contactName,
    contactEmail: TEST_BUILDER.contactEmail,
    contactPhone: TEST_BUILDER.contactPhone,
  });
  ids.builderId = builderResult.builderId;

  // Seed job
  const jobResult = await convex.mutation(api.testing.seedTestJob, {
    organizationId: orgResult.organizationId,
    builderId: builderResult.builderId,
    name: TEST_JOB.name,
    siteAddress: TEST_JOB.siteAddress,
    jobType: TEST_JOB.jobType,
    quotedPrice: TEST_JOB.quotedPrice,
    status: 'active',
  });
  ids.jobId = jobResult.jobId;

  return ids;
}

export async function cleanupTestData(): Promise<void> {
  await convex.mutation(api.testing.cleanupTestData, {
    orgName: TEST_OWNER.orgName,
  });
}
```

**Step 4: Verify Convex compiles**

Run:
```bash
npx convex dev --once
```

Expected: Convex functions compile without errors

**Step 5: Commit**

```bash
git add convex/testing.ts e2e/utils/
git commit -m "feat: add E2E test utilities and Convex seeding functions"
```

---

## Task 3: Create Page Object Models

**Files:**
- Create: `e2e/pages/landing.page.ts`
- Create: `e2e/pages/sign-in.page.ts`
- Create: `e2e/pages/dashboard.page.ts`
- Create: `e2e/pages/jobs.page.ts`
- Create: `e2e/pages/workers.page.ts`
- Create: `e2e/pages/builders.page.ts`

**Step 1: Create Landing page object**

Create `e2e/pages/landing.page.ts`:

```typescript
import { Page, Locator, expect } from '@playwright/test';

export class LandingPage {
  readonly page: Page;
  readonly logo: Locator;
  readonly tagline: Locator;
  readonly signInButton: Locator;

  constructor(page: Page) {
    this.page = page;
    this.logo = page.locator('img[alt*="Ryox"]');
    this.tagline = page.getByText('Carpentry Business Management');
    this.signInButton = page.getByRole('link', { name: 'Sign In' });
  }

  async goto() {
    await this.page.goto('/');
  }

  async expectLoaded() {
    await expect(this.logo).toBeVisible();
    await expect(this.signInButton).toBeVisible();
  }

  async clickSignIn() {
    await this.signInButton.click();
    await this.page.waitForURL('/sign-in');
  }
}
```

**Step 2: Create Sign-in page object**

Create `e2e/pages/sign-in.page.ts`:

```typescript
import { Page, Locator, expect } from '@playwright/test';

export class SignInPage {
  readonly page: Page;
  readonly emailInput: Locator;
  readonly passwordInput: Locator;
  readonly signInButton: Locator;
  readonly errorMessage: Locator;
  readonly logo: Locator;

  constructor(page: Page) {
    this.page = page;
    this.emailInput = page.getByPlaceholder('you@company.com');
    this.passwordInput = page.getByPlaceholder('Enter your password');
    this.signInButton = page.getByRole('button', { name: 'Sign In' });
    this.errorMessage = page.locator('[class*="text-red"]');
    this.logo = page.locator('img[alt*="Ryox"]');
  }

  async goto() {
    await this.page.goto('/sign-in');
  }

  async expectLoaded() {
    await expect(this.emailInput).toBeVisible();
    await expect(this.passwordInput).toBeVisible();
    await expect(this.signInButton).toBeVisible();
  }

  async signIn(email: string, password: string) {
    await this.emailInput.fill(email);
    await this.passwordInput.fill(password);
    await this.signInButton.click();
  }

  async expectError(message: string) {
    await expect(this.errorMessage).toContainText(message);
  }
}
```

**Step 3: Create Dashboard page object**

Create `e2e/pages/dashboard.page.ts`:

```typescript
import { Page, Locator, expect } from '@playwright/test';

export class DashboardPage {
  readonly page: Page;
  readonly heading: Locator;
  readonly sidebar: Locator;
  readonly orgName: Locator;
  readonly userName: Locator;

  // Owner-specific elements
  readonly activeJobsCard: Locator;
  readonly activeWorkersCard: Locator;
  readonly pendingTimesheetsCard: Locator;
  readonly buildersCard: Locator;
  readonly activeJobsList: Locator;
  readonly expiringCertsSection: Locator;

  // Worker-specific elements
  readonly myJobsList: Locator;

  // Navigation links
  readonly dashboardLink: Locator;
  readonly jobsLink: Locator;
  readonly workersLink: Locator;
  readonly buildersLink: Locator;
  readonly timesheetsLink: Locator;
  readonly chatLink: Locator;
  readonly settingsLink: Locator;

  constructor(page: Page) {
    this.page = page;
    this.heading = page.locator('h1');
    this.sidebar = page.locator('aside');
    this.orgName = page.locator('[data-testid="org-name"]');
    this.userName = page.locator('[data-testid="user-name"]');

    // Stats cards (owner)
    this.activeJobsCard = page.locator('text=Active Jobs').locator('..');
    this.activeWorkersCard = page.locator('text=Active Workers').locator('..');
    this.pendingTimesheetsCard = page.locator('text=Pending Timesheets').locator('..');
    this.buildersCard = page.locator('text=Builders').locator('..');

    // Sections
    this.activeJobsList = page.locator('text=Active Jobs').locator('..').locator('xpath=following-sibling::*');
    this.expiringCertsSection = page.locator('text=Expiring Certifications');
    this.myJobsList = page.locator('h2:has-text("My Assigned Jobs")').locator('xpath=following-sibling::*');

    // Nav links
    this.dashboardLink = page.getByRole('link', { name: 'Dashboard' });
    this.jobsLink = page.getByRole('link', { name: 'Jobs' });
    this.workersLink = page.getByRole('link', { name: 'Workers' });
    this.buildersLink = page.getByRole('link', { name: 'Builders' });
    this.timesheetsLink = page.getByRole('link', { name: 'Timesheets' });
    this.chatLink = page.getByRole('link', { name: 'Chat' });
    this.settingsLink = page.getByRole('link', { name: 'Settings' });
  }

  async goto() {
    await this.page.goto('/dashboard');
  }

  async expectLoaded() {
    await expect(this.sidebar).toBeVisible();
    await expect(this.heading).toBeVisible();
  }

  async expectOwnerDashboard() {
    await expect(this.page.getByText('Active Jobs')).toBeVisible();
    await expect(this.page.getByText('Active Workers')).toBeVisible();
    await expect(this.jobsLink).toBeVisible();
    await expect(this.workersLink).toBeVisible();
    await expect(this.buildersLink).toBeVisible();
  }

  async expectWorkerDashboard() {
    await expect(this.page.getByText('My Assigned Jobs')).toBeVisible();
    await expect(this.chatLink).toBeVisible();
    // Workers should NOT see certain links
    await expect(this.workersLink).not.toBeVisible();
    await expect(this.buildersLink).not.toBeVisible();
  }

  async navigateToJobs() {
    await this.jobsLink.click();
    await this.page.waitForURL('/jobs');
  }

  async navigateToWorkers() {
    await this.workersLink.click();
    await this.page.waitForURL('/workers');
  }

  async navigateToBuilders() {
    await this.buildersLink.click();
    await this.page.waitForURL('/builders');
  }
}
```

**Step 4: Create Jobs page object**

Create `e2e/pages/jobs.page.ts`:

```typescript
import { Page, Locator, expect } from '@playwright/test';

export class JobsPage {
  readonly page: Page;
  readonly heading: Locator;
  readonly createJobButton: Locator;
  readonly jobsList: Locator;
  readonly statusFilter: Locator;
  readonly builderFilter: Locator;

  // Create job modal
  readonly modal: Locator;
  readonly jobNameInput: Locator;
  readonly builderSelect: Locator;
  readonly siteAddressInput: Locator;
  readonly jobTypeSelect: Locator;
  readonly quotedPriceInput: Locator;
  readonly startDateInput: Locator;
  readonly submitButton: Locator;
  readonly cancelButton: Locator;

  constructor(page: Page) {
    this.page = page;
    this.heading = page.getByRole('heading', { name: 'Jobs' });
    this.createJobButton = page.getByRole('button', { name: /Create Job|New Job/i });
    this.jobsList = page.locator('[data-testid="jobs-list"]');
    this.statusFilter = page.getByRole('combobox', { name: /status/i });
    this.builderFilter = page.getByRole('combobox', { name: /builder/i });

    // Modal elements
    this.modal = page.locator('[role="dialog"]');
    this.jobNameInput = page.getByLabel(/Job Name/i);
    this.builderSelect = page.getByLabel(/Builder|Client/i);
    this.siteAddressInput = page.getByLabel(/Site Address/i);
    this.jobTypeSelect = page.getByLabel(/Job Type/i);
    this.quotedPriceInput = page.getByLabel(/Quoted Price/i);
    this.startDateInput = page.getByLabel(/Start Date/i);
    this.submitButton = this.modal.getByRole('button', { name: /Create|Save/i });
    this.cancelButton = this.modal.getByRole('button', { name: /Cancel/i });
  }

  async goto() {
    await this.page.goto('/jobs');
  }

  async expectLoaded() {
    await expect(this.heading).toBeVisible();
  }

  async openCreateJobModal() {
    await this.createJobButton.click();
    await expect(this.modal).toBeVisible();
  }

  async expectJobInList(jobName: string) {
    await expect(this.page.getByText(jobName)).toBeVisible();
  }

  async clickJob(jobName: string) {
    await this.page.getByText(jobName).click();
  }
}
```

**Step 5: Create Workers page object**

Create `e2e/pages/workers.page.ts`:

```typescript
import { Page, Locator, expect } from '@playwright/test';

export class WorkersPage {
  readonly page: Page;
  readonly heading: Locator;
  readonly inviteWorkerButton: Locator;
  readonly workersList: Locator;
  readonly pendingInvitesSection: Locator;

  // Invite modal
  readonly inviteModal: Locator;
  readonly emailInput: Locator;
  readonly payRateInput: Locator;
  readonly chargeOutRateInput: Locator;
  readonly tradeSelect: Locator;
  readonly employmentTypeSelect: Locator;
  readonly generateInviteButton: Locator;
  readonly inviteLinkDisplay: Locator;
  readonly copyLinkButton: Locator;

  constructor(page: Page) {
    this.page = page;
    this.heading = page.getByRole('heading', { name: 'Workers' });
    this.inviteWorkerButton = page.getByRole('button', { name: /Invite Worker/i });
    this.workersList = page.locator('[data-testid="workers-list"]');
    this.pendingInvitesSection = page.locator('text=Pending Invites').locator('..');

    // Modal
    this.inviteModal = page.locator('[role="dialog"]');
    this.emailInput = page.getByLabel(/Email/i);
    this.payRateInput = page.getByLabel(/Pay Rate/i);
    this.chargeOutRateInput = page.getByLabel(/Charge.*Rate/i);
    this.tradeSelect = page.getByLabel(/Trade/i);
    this.employmentTypeSelect = page.getByLabel(/Employment Type/i);
    this.generateInviteButton = this.inviteModal.getByRole('button', { name: /Generate|Create|Invite/i });
    this.inviteLinkDisplay = page.locator('[data-testid="invite-link"]');
    this.copyLinkButton = page.getByRole('button', { name: /Copy/i });
  }

  async goto() {
    await this.page.goto('/workers');
  }

  async expectLoaded() {
    await expect(this.heading).toBeVisible();
  }

  async openInviteModal() {
    await this.inviteWorkerButton.click();
    await expect(this.inviteModal).toBeVisible();
  }

  async expectWorkerInList(workerName: string) {
    await expect(this.page.getByText(workerName)).toBeVisible();
  }
}
```

**Step 6: Create Builders page object**

Create `e2e/pages/builders.page.ts`:

```typescript
import { Page, Locator, expect } from '@playwright/test';

export class BuildersPage {
  readonly page: Page;
  readonly heading: Locator;
  readonly addBuilderButton: Locator;
  readonly buildersList: Locator;

  // Add builder modal
  readonly modal: Locator;
  readonly companyNameInput: Locator;
  readonly abnInput: Locator;
  readonly paymentTermsInput: Locator;
  readonly contactNameInput: Locator;
  readonly contactEmailInput: Locator;
  readonly contactPhoneInput: Locator;
  readonly contactRoleInput: Locator;
  readonly submitButton: Locator;
  readonly cancelButton: Locator;

  constructor(page: Page) {
    this.page = page;
    this.heading = page.getByRole('heading', { name: 'Builders' });
    this.addBuilderButton = page.getByRole('button', { name: /Add Builder|New Builder/i });
    this.buildersList = page.locator('[data-testid="builders-list"]');

    // Modal
    this.modal = page.locator('[role="dialog"]');
    this.companyNameInput = page.getByLabel(/Company Name/i);
    this.abnInput = page.getByLabel(/ABN/i);
    this.paymentTermsInput = page.getByLabel(/Payment Terms/i);
    this.contactNameInput = page.getByLabel(/Contact Name/i);
    this.contactEmailInput = page.getByLabel(/Contact Email/i);
    this.contactPhoneInput = page.getByLabel(/Contact Phone/i);
    this.contactRoleInput = page.getByLabel(/Role/i);
    this.submitButton = this.modal.getByRole('button', { name: /Add|Create|Save/i });
    this.cancelButton = this.modal.getByRole('button', { name: /Cancel/i });
  }

  async goto() {
    await this.page.goto('/builders');
  }

  async expectLoaded() {
    await expect(this.heading).toBeVisible();
  }

  async openAddBuilderModal() {
    await this.addBuilderButton.click();
    await expect(this.modal).toBeVisible();
  }

  async expectBuilderInList(companyName: string) {
    await expect(this.page.getByText(companyName)).toBeVisible();
  }
}
```

**Step 7: Commit**

```bash
git add e2e/pages/
git commit -m "feat: add Page Object Models for E2E tests"
```

---

## Task 4: Create Global Setup and Teardown

**Files:**
- Create: `e2e/global-setup.ts`
- Create: `e2e/global-teardown.ts`
- Modify: `playwright.config.ts`

**Step 1: Create global setup**

Create `e2e/global-setup.ts`:

```typescript
import { FullConfig } from '@playwright/test';
import { seedAllTestData, TestDataIds } from './utils/test-data';

let testDataIds: TestDataIds;

async function globalSetup(config: FullConfig) {
  console.log('ðŸŒ± Seeding test data...');

  try {
    testDataIds = await seedAllTestData();
    console.log('âœ… Test data seeded successfully');
    console.log(`   Organization: ${testDataIds.organizationId}`);
    console.log(`   Owner: ${testDataIds.ownerId}`);
    console.log(`   Worker: ${testDataIds.workerId}`);
    console.log(`   Builder: ${testDataIds.builderId}`);
    console.log(`   Job: ${testDataIds.jobId}`);
  } catch (error) {
    console.error('âŒ Failed to seed test data:', error);
    throw error;
  }
}

export default globalSetup;
export { testDataIds };
```

**Step 2: Create global teardown**

Create `e2e/global-teardown.ts`:

```typescript
import { FullConfig } from '@playwright/test';
import { cleanupTestData } from './utils/test-data';

async function globalTeardown(config: FullConfig) {
  console.log('ðŸ§¹ Cleaning up test data...');

  try {
    await cleanupTestData();
    console.log('âœ… Test data cleaned up successfully');
  } catch (error) {
    console.error('âš ï¸ Failed to cleanup test data:', error);
    // Don't throw - cleanup failures shouldn't fail the test run
  }
}

export default globalTeardown;
```

**Step 3: Update Playwright config**

Modify `playwright.config.ts`:

```typescript
import { defineConfig, devices } from '@playwright/test';

export default defineConfig({
  testDir: './e2e',
  fullyParallel: false,
  forbidOnly: !!process.env.CI,
  retries: process.env.CI ? 2 : 0,
  workers: 1,
  reporter: [['html', { open: 'never' }], ['list']],

  globalSetup: './e2e/global-setup.ts',
  globalTeardown: './e2e/global-teardown.ts',

  use: {
    baseURL: 'http://localhost:3000',
    trace: 'on-first-retry',
    screenshot: 'only-on-failure',
    video: 'retain-on-failure',
  },

  projects: [
    {
      name: 'chromium',
      use: { ...devices['Desktop Chrome'] },
    },
  ],

  webServer: {
    command: 'npm run dev',
    url: 'http://localhost:3000',
    reuseExistingServer: !process.env.CI,
    timeout: 120000,
  },
});
```

**Step 4: Commit**

```bash
git add e2e/global-setup.ts e2e/global-teardown.ts playwright.config.ts
git commit -m "feat: add global setup/teardown for E2E test data"
```

---

## Task 5: Test Suite - Landing Page

**Files:**
- Create: `e2e/tests/landing.spec.ts`

**Step 1: Write landing page tests**

Create `e2e/tests/landing.spec.ts`:

```typescript
import { test, expect } from '@playwright/test';
import { LandingPage } from '../pages/landing.page';

test.describe('Landing Page', () => {
  let landingPage: LandingPage;

  test.beforeEach(async ({ page }) => {
    landingPage = new LandingPage(page);
  });

  test('should display Ryox logo and sign in button', async ({ page }) => {
    await landingPage.goto();
    await landingPage.expectLoaded();

    // Check for brand elements
    await expect(page.locator('img[alt*="Ryox"]')).toBeVisible();
    await expect(page.getByRole('link', { name: 'Sign In' })).toBeVisible();
  });

  test('should navigate to sign in page when clicking sign in', async ({ page }) => {
    await landingPage.goto();
    await landingPage.clickSignIn();

    await expect(page).toHaveURL('/sign-in');
  });

  test('should have dark theme styling', async ({ page }) => {
    await landingPage.goto();

    // Verify dark background
    const bgColor = await page.evaluate(() => {
      return window.getComputedStyle(document.body).backgroundColor;
    });

    // Should be dark (low RGB values)
    expect(bgColor).toMatch(/rgb\(\s*\d{1,2}\s*,\s*\d{1,2}\s*,\s*\d{1,2}\s*\)/);
  });
});
```

**Step 2: Run test to verify it works**

Run:
```bash
npm run test:e2e -- e2e/tests/landing.spec.ts
```

Expected: All 3 tests pass

**Step 3: Commit**

```bash
git add e2e/tests/landing.spec.ts
git commit -m "test: add landing page E2E tests"
```

---

## Task 6: Test Suite - Authentication

**Files:**
- Create: `e2e/tests/auth.spec.ts`

**Step 1: Write authentication tests**

Create `e2e/tests/auth.spec.ts`:

```typescript
import { test, expect } from '@playwright/test';
import { SignInPage } from '../pages/sign-in.page';
import { DashboardPage } from '../pages/dashboard.page';
import { TEST_OWNER, TEST_WORKER, logout } from '../utils/auth-helpers';

test.describe('Authentication', () => {
  let signInPage: SignInPage;
  let dashboardPage: DashboardPage;

  test.beforeEach(async ({ page }) => {
    signInPage = new SignInPage(page);
    dashboardPage = new DashboardPage(page);
  });

  test.afterEach(async ({ page }) => {
    await logout(page);
  });

  test('should display sign in form correctly', async ({ page }) => {
    await signInPage.goto();
    await signInPage.expectLoaded();

    // Check for invite-only message
    await expect(page.getByText(/invitation only|invite only/i)).toBeVisible();
  });

  test('should show error for invalid credentials', async ({ page }) => {
    await signInPage.goto();
    await signInPage.signIn('wrong@email.com', 'wrongpassword');

    await signInPage.expectError('Invalid email or password');
  });

  test('should show error for empty fields', async ({ page }) => {
    await signInPage.goto();
    await page.getByRole('button', { name: 'Sign In' }).click();

    // Check for validation
    await expect(page.getByText(/email.*required|enter.*email/i)).toBeVisible();
  });

  test('owner can sign in and see owner dashboard', async ({ page }) => {
    await signInPage.goto();
    await signInPage.signIn(TEST_OWNER.email, TEST_OWNER.password);

    await expect(page).toHaveURL('/dashboard');
    await dashboardPage.expectLoaded();
    await dashboardPage.expectOwnerDashboard();
  });

  test('worker can sign in and see worker dashboard', async ({ page }) => {
    await signInPage.goto();
    await signInPage.signIn(TEST_WORKER.email, TEST_WORKER.password);

    await expect(page).toHaveURL('/dashboard');
    await dashboardPage.expectLoaded();
    await dashboardPage.expectWorkerDashboard();
  });

  test('unauthenticated user is redirected from dashboard', async ({ page }) => {
    // Clear any existing auth
    await logout(page);

    await page.goto('/dashboard');

    // Should redirect to sign-in
    await expect(page).toHaveURL('/sign-in');
  });

  test('sign-up page redirects to sign-in (invite only)', async ({ page }) => {
    await page.goto('/sign-up');

    // Should redirect to sign-in
    await expect(page).toHaveURL('/sign-in');
  });
});
```

**Step 2: Run test to verify it works**

Run:
```bash
npm run test:e2e -- e2e/tests/auth.spec.ts
```

Expected: All 7 tests pass

**Step 3: Commit**

```bash
git add e2e/tests/auth.spec.ts
git commit -m "test: add authentication E2E tests"
```

---

## Task 7: Test Suite - Owner Dashboard & Navigation

**Files:**
- Create: `e2e/tests/owner-dashboard.spec.ts`

**Step 1: Write owner dashboard tests**

Create `e2e/tests/owner-dashboard.spec.ts`:

```typescript
import { test, expect } from '@playwright/test';
import { DashboardPage } from '../pages/dashboard.page';
import { JobsPage } from '../pages/jobs.page';
import { WorkersPage } from '../pages/workers.page';
import { BuildersPage } from '../pages/builders.page';
import { loginAsOwner, logout, TEST_JOB, TEST_WORKER, TEST_BUILDER } from '../utils/auth-helpers';

test.describe('Owner Dashboard', () => {
  let dashboardPage: DashboardPage;

  test.beforeEach(async ({ page }) => {
    dashboardPage = new DashboardPage(page);
    await loginAsOwner(page);
  });

  test.afterEach(async ({ page }) => {
    await logout(page);
  });

  test('should display all stat cards', async ({ page }) => {
    await dashboardPage.expectLoaded();

    // Check for stat cards
    await expect(page.getByText('Active Jobs')).toBeVisible();
    await expect(page.getByText('Active Workers')).toBeVisible();
    await expect(page.getByText('Pending Timesheets')).toBeVisible();
    await expect(page.getByText('Builders')).toBeVisible();
  });

  test('should display seeded job in active jobs list', async ({ page }) => {
    await dashboardPage.expectLoaded();

    // Our seeded job should appear
    await expect(page.getByText(TEST_JOB.name)).toBeVisible();
  });

  test('should navigate to Jobs page', async ({ page }) => {
    const jobsPage = new JobsPage(page);

    await dashboardPage.navigateToJobs();
    await jobsPage.expectLoaded();

    // Seeded job should be visible
    await jobsPage.expectJobInList(TEST_JOB.name);
  });

  test('should navigate to Workers page', async ({ page }) => {
    const workersPage = new WorkersPage(page);

    await dashboardPage.navigateToWorkers();
    await workersPage.expectLoaded();

    // Seeded worker should be visible
    await workersPage.expectWorkerInList(TEST_WORKER.name);
  });

  test('should navigate to Builders page', async ({ page }) => {
    const buildersPage = new BuildersPage(page);

    await dashboardPage.navigateToBuilders();
    await buildersPage.expectLoaded();

    // Seeded builder should be visible
    await buildersPage.expectBuilderInList(TEST_BUILDER.companyName);
  });

  test('should show organization name in sidebar', async ({ page }) => {
    await dashboardPage.expectLoaded();

    // Check sidebar shows org name
    await expect(page.locator('aside')).toContainText('E2E Test Organization');
  });

  test('sidebar should have all owner navigation links', async ({ page }) => {
    await dashboardPage.expectLoaded();

    await expect(dashboardPage.dashboardLink).toBeVisible();
    await expect(dashboardPage.jobsLink).toBeVisible();
    await expect(dashboardPage.workersLink).toBeVisible();
    await expect(dashboardPage.buildersLink).toBeVisible();
    await expect(dashboardPage.timesheetsLink).toBeVisible();
    await expect(dashboardPage.settingsLink).toBeVisible();
  });
});
```

**Step 2: Run test to verify it works**

Run:
```bash
npm run test:e2e -- e2e/tests/owner-dashboard.spec.ts
```

Expected: All 7 tests pass

**Step 3: Commit**

```bash
git add e2e/tests/owner-dashboard.spec.ts
git commit -m "test: add owner dashboard E2E tests"
```

---

## Task 8: Test Suite - Worker Dashboard

**Files:**
- Create: `e2e/tests/worker-dashboard.spec.ts`

**Step 1: Write worker dashboard tests**

Create `e2e/tests/worker-dashboard.spec.ts`:

```typescript
import { test, expect } from '@playwright/test';
import { DashboardPage } from '../pages/dashboard.page';
import { loginAsWorker, logout } from '../utils/auth-helpers';

test.describe('Worker Dashboard', () => {
  let dashboardPage: DashboardPage;

  test.beforeEach(async ({ page }) => {
    dashboardPage = new DashboardPage(page);
    await loginAsWorker(page);
  });

  test.afterEach(async ({ page }) => {
    await logout(page);
  });

  test('should display worker-specific dashboard', async ({ page }) => {
    await dashboardPage.expectLoaded();
    await dashboardPage.expectWorkerDashboard();

    // Should show "My Assigned Jobs" heading
    await expect(page.getByText('My Assigned Jobs')).toBeVisible();
  });

  test('should NOT show owner-only navigation items', async ({ page }) => {
    await dashboardPage.expectLoaded();

    // Workers should not see these links
    await expect(dashboardPage.workersLink).not.toBeVisible();
    await expect(dashboardPage.buildersLink).not.toBeVisible();
  });

  test('should show worker navigation items', async ({ page }) => {
    await dashboardPage.expectLoaded();

    // Workers should see these
    await expect(page.getByRole('link', { name: 'My Jobs' })).toBeVisible();
    await expect(dashboardPage.timesheetsLink).toBeVisible();
    await expect(dashboardPage.chatLink).toBeVisible();
  });

  test('should show assigned jobs when allocated', async ({ page }) => {
    await dashboardPage.expectLoaded();

    // If the worker is allocated to a job, it should appear here
    // Note: This depends on whether the seeding includes allocation
    // For now, just verify the list container exists
    await expect(page.locator('text=My Assigned Jobs')).toBeVisible();
  });

  test('should display worker name in sidebar', async ({ page }) => {
    await dashboardPage.expectLoaded();

    // Check sidebar shows worker name
    await expect(page.locator('aside')).toContainText('E2E Test Worker');
  });
});
```

**Step 2: Run test to verify it works**

Run:
```bash
npm run test:e2e -- e2e/tests/worker-dashboard.spec.ts
```

Expected: All 5 tests pass

**Step 3: Commit**

```bash
git add e2e/tests/worker-dashboard.spec.ts
git commit -m "test: add worker dashboard E2E tests"
```

---

## Task 9: Test Suite - Jobs CRUD

**Files:**
- Create: `e2e/tests/jobs.spec.ts`

**Step 1: Write jobs CRUD tests**

Create `e2e/tests/jobs.spec.ts`:

```typescript
import { test, expect } from '@playwright/test';
import { JobsPage } from '../pages/jobs.page';
import { loginAsOwner, logout, TEST_JOB, TEST_BUILDER } from '../utils/auth-helpers';

test.describe('Jobs Management', () => {
  let jobsPage: JobsPage;

  test.beforeEach(async ({ page }) => {
    jobsPage = new JobsPage(page);
    await loginAsOwner(page);
    await jobsPage.goto();
  });

  test.afterEach(async ({ page }) => {
    await logout(page);
  });

  test('should display jobs page correctly', async ({ page }) => {
    await jobsPage.expectLoaded();

    // Check for key elements
    await expect(jobsPage.createJobButton).toBeVisible();
  });

  test('should display seeded job in list', async ({ page }) => {
    await jobsPage.expectLoaded();
    await jobsPage.expectJobInList(TEST_JOB.name);
  });

  test('should open create job modal', async ({ page }) => {
    await jobsPage.openCreateJobModal();

    // Check modal is visible with form fields
    await expect(jobsPage.modal).toBeVisible();
  });

  test('should show job details when clicking a job', async ({ page }) => {
    await jobsPage.expectLoaded();

    // Click on the seeded job
    await page.getByText(TEST_JOB.name).first().click();

    // Should see job details (either in modal or new page)
    await expect(page.getByText(TEST_JOB.siteAddress)).toBeVisible();
  });

  test('should display job type badge', async ({ page }) => {
    await jobsPage.expectLoaded();

    // Jobs should show their type
    await expect(page.getByText(/contract|labour hire/i).first()).toBeVisible();
  });

  test('should display job status', async ({ page }) => {
    await jobsPage.expectLoaded();

    // Jobs should show status (our seeded job is 'active')
    await expect(page.getByText(/active|pending|completed/i).first()).toBeVisible();
  });

  test('should show builder name on job card', async ({ page }) => {
    await jobsPage.expectLoaded();

    // Job should show associated builder
    await expect(page.getByText(TEST_BUILDER.companyName)).toBeVisible();
  });
});
```

**Step 2: Run test to verify it works**

Run:
```bash
npm run test:e2e -- e2e/tests/jobs.spec.ts
```

Expected: All 7 tests pass

**Step 3: Commit**

```bash
git add e2e/tests/jobs.spec.ts
git commit -m "test: add jobs management E2E tests"
```

---

## Task 10: Test Suite - Workers Management

**Files:**
- Create: `e2e/tests/workers.spec.ts`

**Step 1: Write workers management tests**

Create `e2e/tests/workers.spec.ts`:

```typescript
import { test, expect } from '@playwright/test';
import { WorkersPage } from '../pages/workers.page';
import { loginAsOwner, logout, TEST_WORKER } from '../utils/auth-helpers';

test.describe('Workers Management', () => {
  let workersPage: WorkersPage;

  test.beforeEach(async ({ page }) => {
    workersPage = new WorkersPage(page);
    await loginAsOwner(page);
    await workersPage.goto();
  });

  test.afterEach(async ({ page }) => {
    await logout(page);
  });

  test('should display workers page correctly', async ({ page }) => {
    await workersPage.expectLoaded();

    // Check for key elements
    await expect(workersPage.inviteWorkerButton).toBeVisible();
  });

  test('should display seeded worker in list', async ({ page }) => {
    await workersPage.expectLoaded();
    await workersPage.expectWorkerInList(TEST_WORKER.name);
  });

  test('should show worker details', async ({ page }) => {
    await workersPage.expectLoaded();

    // Worker card should show relevant info
    await expect(page.getByText(TEST_WORKER.email)).toBeVisible();
  });

  test('should show worker pay rate', async ({ page }) => {
    await workersPage.expectLoaded();

    // Should show pay rate somewhere
    await expect(page.getByText(`$${TEST_WORKER.payRate}`)).toBeVisible();
  });

  test('should show worker charge-out rate', async ({ page }) => {
    await workersPage.expectLoaded();

    // Should show charge-out rate
    await expect(page.getByText(`$${TEST_WORKER.chargeOutRate}`)).toBeVisible();
  });

  test('should open invite worker modal', async ({ page }) => {
    await workersPage.openInviteModal();

    // Check modal is visible
    await expect(workersPage.inviteModal).toBeVisible();
  });

  test('invite modal should have required fields', async ({ page }) => {
    await workersPage.openInviteModal();

    // Check for form fields
    await expect(workersPage.payRateInput).toBeVisible();
    await expect(workersPage.chargeOutRateInput).toBeVisible();
  });

  test('should show pending invites section', async ({ page }) => {
    await workersPage.expectLoaded();

    // Check for pending invites section (may be empty)
    await expect(page.getByText(/Pending Invites|No pending invites/i)).toBeVisible();
  });
});
```

**Step 2: Run test to verify it works**

Run:
```bash
npm run test:e2e -- e2e/tests/workers.spec.ts
```

Expected: All 8 tests pass

**Step 3: Commit**

```bash
git add e2e/tests/workers.spec.ts
git commit -m "test: add workers management E2E tests"
```

---

## Task 11: Test Suite - Builders Management

**Files:**
- Create: `e2e/tests/builders.spec.ts`

**Step 1: Write builders management tests**

Create `e2e/tests/builders.spec.ts`:

```typescript
import { test, expect } from '@playwright/test';
import { BuildersPage } from '../pages/builders.page';
import { loginAsOwner, logout, TEST_BUILDER } from '../utils/auth-helpers';

test.describe('Builders Management', () => {
  let buildersPage: BuildersPage;

  test.beforeEach(async ({ page }) => {
    buildersPage = new BuildersPage(page);
    await loginAsOwner(page);
    await buildersPage.goto();
  });

  test.afterEach(async ({ page }) => {
    await logout(page);
  });

  test('should display builders page correctly', async ({ page }) => {
    await buildersPage.expectLoaded();

    // Check for key elements
    await expect(buildersPage.addBuilderButton).toBeVisible();
  });

  test('should display seeded builder in list', async ({ page }) => {
    await buildersPage.expectLoaded();
    await buildersPage.expectBuilderInList(TEST_BUILDER.companyName);
  });

  test('should show builder contact info', async ({ page }) => {
    await buildersPage.expectLoaded();

    // Should show contact details
    await expect(page.getByText(TEST_BUILDER.contactName)).toBeVisible();
  });

  test('should show builder contact email', async ({ page }) => {
    await buildersPage.expectLoaded();

    await expect(page.getByText(TEST_BUILDER.contactEmail)).toBeVisible();
  });

  test('should open add builder modal', async ({ page }) => {
    await buildersPage.openAddBuilderModal();

    // Check modal is visible
    await expect(buildersPage.modal).toBeVisible();
  });

  test('add builder modal should have required fields', async ({ page }) => {
    await buildersPage.openAddBuilderModal();

    // Check for form fields
    await expect(buildersPage.companyNameInput).toBeVisible();
    await expect(buildersPage.abnInput).toBeVisible();
  });

  test('should show job count for builder', async ({ page }) => {
    await buildersPage.expectLoaded();

    // Our seeded builder has 1 job
    await expect(page.getByText(/1\s*job|jobs:\s*1/i)).toBeVisible();
  });
});
```

**Step 2: Run test to verify it works**

Run:
```bash
npm run test:e2e -- e2e/tests/builders.spec.ts
```

Expected: All 7 tests pass

**Step 3: Commit**

```bash
git add e2e/tests/builders.spec.ts
git commit -m "test: add builders management E2E tests"
```

---

## Task 12: Test Suite - Worker Invite Flow (E2E User Journey)

**Files:**
- Create: `e2e/tests/worker-invite-flow.spec.ts`

**Step 1: Write worker invite flow tests**

Create `e2e/tests/worker-invite-flow.spec.ts`:

```typescript
import { test, expect } from '@playwright/test';
import { WorkersPage } from '../pages/workers.page';
import { loginAsOwner, logout } from '../utils/auth-helpers';
import { ConvexHttpClient } from 'convex/browser';
import { api } from '../../convex/_generated/api';

test.describe('Worker Invite Flow', () => {
  test('complete invite flow: owner creates invite, worker accepts', async ({ page, context }) => {
    // Step 1: Owner logs in and creates invite
    await loginAsOwner(page);
    await page.goto('/workers');

    // Open invite modal
    await page.getByRole('button', { name: /Invite Worker/i }).click();
    await expect(page.locator('[role="dialog"]')).toBeVisible();

    // Fill invite form with unique email to avoid conflicts
    const uniqueEmail = `new-worker-${Date.now()}@test.carptrack.com`;

    // Fill in the form (adjust selectors based on actual UI)
    const emailField = page.getByLabel(/Email/i);
    if (await emailField.isVisible()) {
      await emailField.fill(uniqueEmail);
    }

    await page.getByLabel(/Pay Rate/i).fill('60');
    await page.getByLabel(/Charge.*Rate/i).fill('90');

    // Select trade classification
    const tradeSelect = page.getByLabel(/Trade/i);
    if (await tradeSelect.isVisible()) {
      await tradeSelect.selectOption('qualified');
    }

    // Select employment type
    const employmentSelect = page.getByLabel(/Employment/i);
    if (await employmentSelect.isVisible()) {
      await employmentSelect.selectOption('employee');
    }

    // Generate invite
    await page.getByRole('button', { name: /Generate|Create|Invite/i }).click();

    // Wait for invite link to appear
    await expect(page.getByText(/invite.*link|link.*generated/i)).toBeVisible({ timeout: 10000 });

    // Get the invite link (look for a link or text containing /invite/)
    const inviteLink = await page.locator('text=/invite/').textContent();
    expect(inviteLink).toBeTruthy();

    // Extract the token from the link
    const tokenMatch = inviteLink?.match(/\/invite\/([a-zA-Z0-9]+)/);
    expect(tokenMatch).toBeTruthy();
    const token = tokenMatch![1];

    // Logout owner
    await logout(page);

    // Step 2: Worker visits invite link
    await page.goto(`/invite/${token}`);

    // Should see invite page with org name
    await expect(page.getByText('E2E Test Organization')).toBeVisible();

    // Fill worker profile form
    await page.getByLabel(/Full Name|Name/i).fill('New Invited Worker');
    await page.getByLabel(/Email/i).fill(uniqueEmail);
    await page.getByLabel(/Phone/i).fill('0411111111');

    // Emergency contact
    const emergencyName = page.getByLabel(/Emergency.*Name/i);
    if (await emergencyName.isVisible()) {
      await emergencyName.fill('Emergency Person');
    }
    const emergencyPhone = page.getByLabel(/Emergency.*Phone/i);
    if (await emergencyPhone.isVisible()) {
      await emergencyPhone.fill('0422222222');
    }

    // Password
    await page.getByLabel(/Password/i).first().fill('NewWorker123!');
    const confirmPassword = page.getByLabel(/Confirm Password/i);
    if (await confirmPassword.isVisible()) {
      await confirmPassword.fill('NewWorker123!');
    }

    // Accept invite
    await page.getByRole('button', { name: /Accept|Join|Create Account/i }).click();

    // Should be logged in and redirected to dashboard
    await expect(page).toHaveURL('/dashboard', { timeout: 10000 });

    // Should see worker dashboard
    await expect(page.getByText('My Assigned Jobs')).toBeVisible();

    // Cleanup: logout
    await logout(page);
  });

  test('expired invite token shows error', async ({ page }) => {
    // Visit with a fake/expired token
    await page.goto('/invite/expired-fake-token-12345');

    // Should show error message
    await expect(page.getByText(/invalid|expired|not found/i)).toBeVisible();
  });

  test('invite page shows organization name', async ({ page }) => {
    // First, create a valid invite via API
    const convex = new ConvexHttpClient(process.env.NEXT_PUBLIC_CONVEX_URL!);

    // Login as owner first to get userId
    await loginAsOwner(page);

    // Get userId from localStorage
    const userId = await page.evaluate(() => localStorage.getItem('carptrack_user_id'));
    expect(userId).toBeTruthy();

    // Create invite via API
    const invite = await convex.mutation(api.workerInvites.createInvite, {
      createdBy: userId as any,
      payRate: 50,
      chargeOutRate: 80,
      employmentType: 'employee',
      tradeClassification: 'apprentice',
    });

    await logout(page);

    // Visit invite page
    await page.goto(`/invite/${invite.token}`);

    // Should show organization name
    await expect(page.getByText('E2E Test Organization')).toBeVisible();
  });
});
```

**Step 2: Run test to verify it works**

Run:
```bash
npm run test:e2e -- e2e/tests/worker-invite-flow.spec.ts
```

Expected: All 3 tests pass

**Step 3: Commit**

```bash
git add e2e/tests/worker-invite-flow.spec.ts
git commit -m "test: add worker invite flow E2E tests"
```

---

## Task 13: Test Suite - Full User Journey

**Files:**
- Create: `e2e/tests/full-journey.spec.ts`

**Step 1: Write full user journey test**

Create `e2e/tests/full-journey.spec.ts`:

```typescript
import { test, expect } from '@playwright/test';
import { LandingPage } from '../pages/landing.page';
import { SignInPage } from '../pages/sign-in.page';
import { DashboardPage } from '../pages/dashboard.page';
import { JobsPage } from '../pages/jobs.page';
import { WorkersPage } from '../pages/workers.page';
import { BuildersPage } from '../pages/builders.page';
import { TEST_OWNER, TEST_WORKER, TEST_JOB, TEST_BUILDER, logout } from '../utils/auth-helpers';

test.describe('Full User Journey', () => {

  test('owner complete workflow: login -> view dashboard -> check jobs -> check workers -> check builders', async ({ page }) => {
    const landingPage = new LandingPage(page);
    const signInPage = new SignInPage(page);
    const dashboardPage = new DashboardPage(page);
    const jobsPage = new JobsPage(page);
    const workersPage = new WorkersPage(page);
    const buildersPage = new BuildersPage(page);

    // 1. Start at landing page
    await landingPage.goto();
    await landingPage.expectLoaded();

    // 2. Navigate to sign in
    await landingPage.clickSignIn();
    await signInPage.expectLoaded();

    // 3. Sign in as owner
    await signInPage.signIn(TEST_OWNER.email, TEST_OWNER.password);
    await expect(page).toHaveURL('/dashboard');

    // 4. Verify dashboard loads with stats
    await dashboardPage.expectLoaded();
    await dashboardPage.expectOwnerDashboard();

    // 5. Navigate to Jobs and verify seeded data
    await dashboardPage.navigateToJobs();
    await jobsPage.expectLoaded();
    await jobsPage.expectJobInList(TEST_JOB.name);

    // 6. Navigate to Workers and verify seeded data
    await page.goto('/workers');
    await workersPage.expectLoaded();
    await workersPage.expectWorkerInList(TEST_WORKER.name);

    // 7. Navigate to Builders and verify seeded data
    await page.goto('/builders');
    await buildersPage.expectLoaded();
    await buildersPage.expectBuilderInList(TEST_BUILDER.companyName);

    // 8. Return to dashboard
    await page.goto('/dashboard');
    await dashboardPage.expectLoaded();

    // Cleanup
    await logout(page);
  });

  test('worker complete workflow: login -> view assigned jobs', async ({ page }) => {
    const landingPage = new LandingPage(page);
    const signInPage = new SignInPage(page);
    const dashboardPage = new DashboardPage(page);

    // 1. Start at landing page
    await landingPage.goto();
    await landingPage.clickSignIn();

    // 2. Sign in as worker
    await signInPage.signIn(TEST_WORKER.email, TEST_WORKER.password);
    await expect(page).toHaveURL('/dashboard');

    // 3. Verify worker dashboard
    await dashboardPage.expectLoaded();
    await dashboardPage.expectWorkerDashboard();

    // 4. Verify navigation is restricted
    await expect(dashboardPage.workersLink).not.toBeVisible();
    await expect(dashboardPage.buildersLink).not.toBeVisible();

    // 5. Verify worker-specific nav is present
    await expect(dashboardPage.chatLink).toBeVisible();
    await expect(dashboardPage.timesheetsLink).toBeVisible();

    // Cleanup
    await logout(page);
  });

  test('role switching: owner logs out, worker logs in', async ({ page }) => {
    const signInPage = new SignInPage(page);
    const dashboardPage = new DashboardPage(page);

    // 1. Login as owner
    await signInPage.goto();
    await signInPage.signIn(TEST_OWNER.email, TEST_OWNER.password);
    await dashboardPage.expectOwnerDashboard();

    // 2. Logout
    await logout(page);

    // 3. Login as worker
    await signInPage.goto();
    await signInPage.signIn(TEST_WORKER.email, TEST_WORKER.password);
    await dashboardPage.expectWorkerDashboard();

    // Cleanup
    await logout(page);
  });

  test('navigation breadcrumb: deep link then navigate back', async ({ page }) => {
    const dashboardPage = new DashboardPage(page);

    // Login as owner
    await page.goto('/sign-in');
    await page.getByPlaceholder('you@company.com').fill(TEST_OWNER.email);
    await page.getByPlaceholder('Enter your password').fill(TEST_OWNER.password);
    await page.getByRole('button', { name: 'Sign In' }).click();
    await expect(page).toHaveURL('/dashboard');

    // Deep link to jobs
    await page.goto('/jobs');
    await expect(page.getByRole('heading', { name: 'Jobs' })).toBeVisible();

    // Navigate back via sidebar
    await dashboardPage.dashboardLink.click();
    await expect(page).toHaveURL('/dashboard');

    // Cleanup
    await logout(page);
  });
});
```

**Step 2: Run test to verify it works**

Run:
```bash
npm run test:e2e -- e2e/tests/full-journey.spec.ts
```

Expected: All 4 tests pass

**Step 3: Commit**

```bash
git add e2e/tests/full-journey.spec.ts
git commit -m "test: add full user journey E2E tests"
```

---

## Task 14: Add CI Configuration (GitHub Actions)

**Files:**
- Create: `.github/workflows/e2e.yml`

**Step 1: Create GitHub Actions workflow**

Create `.github/workflows/e2e.yml`:

```yaml
name: E2E Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  e2e:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install chromium --with-deps

      - name: Start Convex dev server
        run: |
          npx convex dev &
          sleep 10
        env:
          CONVEX_DEPLOYMENT: ${{ secrets.CONVEX_DEPLOYMENT }}

      - name: Run E2E tests
        run: npm run test:e2e
        env:
          NEXT_PUBLIC_CONVEX_URL: ${{ secrets.NEXT_PUBLIC_CONVEX_URL }}

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 7

      - name: Upload test screenshots
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: test-screenshots
          path: test-results/
          retention-days: 7
```

**Step 2: Add to gitignore**

Add to `.gitignore`:

```
# Playwright
playwright-report/
test-results/
.playwright/
```

**Step 3: Commit**

```bash
git add .github/workflows/e2e.yml .gitignore
git commit -m "ci: add GitHub Actions workflow for E2E tests"
```

---

## Task 15: Run Full Test Suite and Verify

**Step 1: Run all E2E tests**

Run:
```bash
npm run test:e2e
```

Expected: All tests pass (44+ tests across 9 spec files)

**Step 2: Generate HTML report**

Run:
```bash
npx playwright show-report
```

Expected: Opens HTML report in browser showing all test results

**Step 3: Final commit**

```bash
git add -A
git commit -m "test: complete E2E test suite for CarpTrack"
```

---

## Summary

This plan creates a comprehensive E2E test suite covering:

| Test Suite | Tests | Coverage |
|------------|-------|----------|
| Landing Page | 3 | Public landing page, navigation |
| Authentication | 7 | Sign in, sign out, redirects, validation |
| Owner Dashboard | 7 | Stats, navigation, data display |
| Worker Dashboard | 5 | Role-restricted view, navigation |
| Jobs Management | 7 | List, create modal, details |
| Workers Management | 8 | List, invite modal, details |
| Builders Management | 7 | List, add modal, details |
| Worker Invite Flow | 3 | Full invite â†’ accept flow |
| Full User Journey | 4 | Complete workflows |

**Total: ~51 tests**

Key patterns used:
- **Page Object Model**: Maintainable, reusable page interactions
- **Test Data Seeding**: Convex mutations for consistent state
- **Global Setup/Teardown**: Clean slate for each run
- **Auth Helpers**: Reusable login/logout functions
- **CI Integration**: GitHub Actions for automated testing
